---
import '@/styles/global.css'
import type { PostLayoutProps } from '@/types'
import FormattedDate from '@/components/widgets/FormattedDate.astro'
import FootnoteScroll from '@/components/widgets/FootnoteScroll.astro'
import BaseHead from '@/components/layout/BaseHead.astro'
import ThemeToggle from '@/components/ui/ThemeToggle.astro'
import Footer from '@/components/layout/Footer.astro'
import BackButton from '@/components/ui/BackButton.astro'
import TableOfContents from '@/components/ui/TableOfContents.astro'
import GradientMask from '@/components/ui/GradientMask.astro'
import ImageOptimizer from '@/components/ui/ImageOptimizer.astro'
import ImageViewer from '@/components/ui/ImageViewer.astro'
import GitHubCard from '@/components/ui/GitHubCard.astro'
import LinkCard from '@/components/ui/LinkCard.astro'
import NeoDBCard from '@/components/ui/NeoDBCard.astro'
import XPOST from '@/components/ui/XPOST.astro'
import CopyCode from '@/components/ui/CopyCode.astro'
import BaseLayout from '@/layouts/BaseLayout.astro'
import Timer from 'phosphor-astro/Timer.astro'
import Header from '@/components/layout/Header.astro'

import { themeConfig } from '@/config'

const { title, pubDate, readingTime, toc } = Astro.props as PostLayoutProps

const postSlug = Astro.url.pathname.split('/').filter(Boolean).pop() || ''
const ogImage = `/open-graph/${postSlug}.png`
---

<Header />
<br />
<BaseLayout
  title={`${title} · ${themeConfig.site.title}`}
  description={themeConfig.site.description}
  type="post"
>
  <BaseHead
    title={`${title} · ${themeConfig.site.title}`}
    description={themeConfig.site.description}
    ogImage={ogImage}
    slot="head"
  />
  <div class="post-container">
    <main>
      <div class="prose">
        <GradientMask />
        <BackButton />
        {themeConfig.post.toc && <TableOfContents toc={toc} />}
        <div class="title">
          <h1>{title}</h1>
          <div class="date">
            <FormattedDate date={pubDate} context="post" />
            {
              themeConfig.post.readingTime && readingTime && (
                <span class="reading-time">
                  <span class="separator">·</span>
                  <Timer width={20} height={20} /> {readingTime.text}
                </span>
              )
            }
          </div>
        </div>
        <slot />
      </div>
      <div id="giscus-container"></div>
    </main>
    <ImageOptimizer />
    <FootnoteScroll />
    <CopyCode />
    <GitHubCard />
    <XPOST />
    <NeoDBCard />
    {themeConfig.post.imageViewer && <ImageViewer />}
    {themeConfig.post.linkCard && <LinkCard />}
    {themeConfig.general.footer && <Footer />}
  </div>
</BaseLayout>

<style>
  .post-container {
    display: flex;
    flex-direction: column;
    flex: 1;
  }

  .post-container main {
    flex: 1;
  }
</style>

<script>
  function getActiveContainer(targetDocument = document) {
    const containers = targetDocument.querySelectorAll('#giscus-container')
    return containers[containers.length - 1] || null
  }

  function loadGiscus(targetDocument = document) {
    const container = getActiveContainer(targetDocument)
    if (!container) return

    // Reset container before injecting the giscus client
    container.innerHTML = ''

    // Create giscus script element
    const s = document.createElement('script')
    s.src = 'https://giscus.app/client.js'
    s.async = true
    s.crossOrigin = 'anonymous'

    // Mirror widget configuration via data-* attributes
    s.setAttribute('data-repo', 'skywalker23241/Cooper')
    s.setAttribute('data-repo-id', 'R_kgDOPqK45Q')
    s.setAttribute('data-category', 'General')
    s.setAttribute('data-category-id', 'DIC_kwDOPqK45c4CvRi6')
    s.setAttribute('data-mapping', 'pathname')
    s.setAttribute('data-strict', '0')
    s.setAttribute('data-reactions-enabled', '1')
    s.setAttribute('data-emit-metadata', '0')
    s.setAttribute('data-input-position', 'bottom')
    s.setAttribute('data-theme', 'transparent_dark')
    s.setAttribute('data-lang', 'en')

    container.appendChild(s)
  }

  function getDocumentFromEvent(event) {
    return event?.detail?.newDocument || event?.detail?.document || document
  }

  // Initial load
  loadGiscus()

  // React to Astro view transitions
  document.addEventListener('astro:page-load', (event) => {
    loadGiscus(getDocumentFromEvent(event))
  })

  document.addEventListener('astro:after-swap', (event) => {
    loadGiscus(getDocumentFromEvent(event))
  })

  // Back/forward navigation
  window.addEventListener('popstate', () => {
    loadGiscus()
  })
</script>
