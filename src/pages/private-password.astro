---
import IndexLayout from '@/layouts/IndexLayout.astro'

const pageTitle = 'Private Password Setup'
const pageDescription = 'Generate and configure the password that protects /private.'
---

<IndexLayout title={pageTitle} description={pageDescription}>
  <section class="password-admin">
    <header class="admin-header">
      <p class="eyebrow">Owner Tools</p>
      <h1>{pageTitle}</h1>
      <p class="lede">
        在部署前先在本地或 Netlify 环境变量中设置 <code>PRIVATE_PAGE_PASSWORD</code>。下面的面板提供了密码建议、配置
        snippet 以及快速复制按钮。
      </p>
    </header>

    <form id="password-admin-form" class="password-form card" autocomplete="off">
      <label for="password-admin-input">输入或生成暗号</label>
      <div class="input-row">
        <input
          id="password-admin-input"
          name="password"
          type="text"
          placeholder="输入 12+ 位密码"
          minlength="4"
          required
        />
        <button type="button" id="password-admin-generate" class="ghost">生成</button>
      </div>
      <p class="hint">⚠️ 该页面不会向服务器发送密码，仅在本地帮助你准备配置。</p>
    </form>

    <article class="preview card">
      <div>
        <p class="eyebrow">Preview</p>
        <h2 id="password-preview">••••••</h2>
        <p class="lede">
          将下方 Snippet 粘贴到 <code>.env</code>、<code>.env.production</code> 或 Netlify 环境变量面板中，然后重新部署。
        </p>
      </div>
      <div class="snippet-block">
        <pre id="password-snippet">PRIVATE_PAGE_PASSWORD=your-password</pre>
        <button type="button" id="password-copy" data-copy-value="PRIVATE_PAGE_PASSWORD=your-password">
          复制 Snippet
        </button>
      </div>
    </article>

    <article class="steps card">
      <h3>配置步骤</h3>
      <ol>
        <li>本地开发：在仓库根目录创建 <code>.env</code>，追加 <code>PRIVATE_PAGE_PASSWORD=xxxxx</code>。</li>
        <li>Netlify：进入 Site settings → Build &amp; deploy → Environment → Edit variables → 新增同名变量。</li>
        <li>重新运行 <code>pnpm dev</code> 或重新部署，<code>/private</code> 页面将调用 API 验证暗号。</li>
      </ol>
      <p class="note">提示：定期轮换暗号，并通知被授权的朋友更新，以防链接在公开渠道传播。</p>
    </article>
  </section>
</IndexLayout>

<script type="module">
  const form = document.querySelector('#password-admin-form')
  const input = document.querySelector('#password-admin-input')
  const preview = document.querySelector('#password-preview')
  const snippet = document.querySelector('#password-snippet')
  const copyButton = document.querySelector('#password-copy')
  const generateButton = document.querySelector('#password-admin-generate')

  const buildSnippet = (value) => `PRIVATE_PAGE_PASSWORD=${value || 'your-password'}`

  const updatePreview = () => {
    if (!input || !preview || !snippet || !copyButton) return
    const value = input.value.trim()
    preview.textContent = value ? value : '••••••'
    const snippetText = buildSnippet(value)
    snippet.textContent = snippetText
    copyButton.dataset.copyValue = snippetText
  }

  const randomPassword = (length = 18) => {
    const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%^&*()-_=+'
    const array = Array.from({ length }, () => alphabet[Math.floor(Math.random() * alphabet.length)])
    return array.join('')
  }

  form?.addEventListener('input', updatePreview)
  form?.addEventListener('submit', (event) => {
    event.preventDefault()
  })

  generateButton?.addEventListener('click', () => {
    if (!input) return
    input.value = randomPassword()
    updatePreview()
  })

  copyButton?.addEventListener('click', async () => {
    if (!copyButton?.dataset.copyValue) return
    try {
      await navigator.clipboard.writeText(copyButton.dataset.copyValue)
      copyButton.textContent = '已复制'
    } catch {
      copyButton.textContent = '无法复制'
    } finally {
      setTimeout(() => {
        copyButton.textContent = '复制 Snippet'
      }, 1600)
    }
  })

  updatePreview()
</script>

<style>
  .password-admin {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .admin-header {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .admin-header h1 {
    margin: 0;
  }

  .eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.2em;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin: 0;
  }

  .lede {
    margin: 0;
    color: var(--text-secondary);
    max-width: 52ch;
  }

  .card {
    padding: 1.5rem;
    border-radius: 1.25rem;
    border: 1px solid color-mix(in srgb, var(--border) 70%, transparent);
    background: color-mix(in srgb, var(--bg) 92%, var(--astro-code-background));
    backdrop-filter: blur(12px);
  }

  .password-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .input-row {
    display: flex;
    gap: 0.75rem;
    align-items: center;
  }

  .input-row input {
    flex: 1;
    padding: 0.85rem 1rem;
    border-radius: 1rem;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text-primary);
  }

  .input-row .ghost {
    border-radius: 1rem;
    padding: 0.75rem 1.5rem;
    border: 1px solid var(--border);
    background: transparent;
    cursor: pointer;
    transition: border-color 0.2s ease;
  }

  .input-row .ghost:hover {
    border-color: var(--text-primary);
  }

  .hint {
    margin: 0;
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  .preview {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .snippet-block {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  pre {
    margin: 0;
    padding: 0.75rem 1rem;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 0.75rem;
    overflow-x: auto;
  }

  .snippet-block button {
    align-self: flex-start;
    padding: 0.5rem 1.25rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: transparent;
    cursor: pointer;
    transition: border-color 0.2s ease;
  }

  .snippet-block button:hover {
    border-color: var(--text-primary);
  }

  .steps ol {
    margin: 0;
    padding-left: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .steps .note {
    margin: 1rem 0 0;
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  @media (max-width: 640px) {
    .input-row {
      flex-direction: column;
      align-items: stretch;
    }

    .input-row .ghost {
      width: 100%;
    }
  }
</style>
