---
import IndexLayout from '@/layouts/IndexLayout.astro'
import LockKey from 'phosphor-astro/LockKey.astro'

const pageTitle = 'Secret Garden'
const pageDescription = "Cooper's Secret Garden"
---

<IndexLayout title={pageTitle} description={pageDescription}>
  <section class="private-page" data-state="locked" data-fallback-title={pageTitle}>
    <header class="private-header">
      <div class="header-icon">
        <LockKey width={32} height={32} />
      </div>
      <p class="eyebrow">Restricted Â· ç§å¯†ç©ºé—´</p>
      <h1>{pageTitle}</h1>
      <p class="lede">
        è¿™æ˜¯ä¸€ä¸ªåªä¸å°‘æ•°æœ‹å‹å…±äº«çš„å®éªŒå®¤ã€‚è¾“å…¥æˆ‘ä»¬çš„çº¦å®šæš—å·ï¼ŒNetlify Function ä¼šæŒ‰éœ€è¿”å›ç»è¿‡ç­¾åçš„çœŸå®å†…å®¹ã€‚
      </p>
    </header>

    <form id="password-form" class="password-form card" autocomplete="off">
      <label for="password-input">è¯·è¾“å…¥æš—å·ä»¥è¿›è¡Œè¿œç«¯éªŒè¯</label>
      <div class="input-row">
        <input
          id="password-input"
          name="password"
          type="password"
          placeholder="******"
          minlength="4"
          required
          autocomplete="current-password"
        />
        <button id="unlock-button" type="submit">è§£é”</button>
      </div>
      <p id="password-status" class="status" aria-live="polite" hidden></p>
      <p id="password-error" class="error" hidden>
        æš—å·ä¸æ­£ç¡®æˆ–å·²è¿‡æœŸï¼Œè¯·é‡è¯•æˆ–<a href="https://www.hopp.bio/junbo-le" target="_blank" rel="noreferrer">è”ç³»æˆ‘</a>
        ã€‚
      </p>
    </form>

    <article id="private-content" class="private-content card" aria-live="polite">
      <div class="lock-placeholder">
        <p class="placeholder-kicker">Encrypted channel</p>
        <h2>Access requires our shared secret</h2>
        <p>
          è¾“å…¥æš—å·åï¼Œé¡µé¢ä¼šå‘ <code>/api/private</code> å‘é€è¯·æ±‚ï¼Œåªæœ‰éªŒè¯é€šè¿‡æ—¶æ‰ä¼šå°†çœŸå®æ•°æ®å†™å…¥è¿™ä¸ªé¢æ¿ã€‚
        </p>
        <div class="placeholder-glow" aria-hidden="true"></div>
      </div>
    </article>

    <button id="lock-page" type="button" class="secondary" hidden>é”å®šé¡µé¢</button>
  </section>
</IndexLayout>

<script type="module">
  const initPrivatePage = () => {
    const root = document.querySelector('.private-page')
    if (!root || root.dataset.ready === 'true') {
      return
    }

    root.dataset.ready = 'true'
    const fallbackTitle = root.dataset.fallbackTitle || 'Secret Garden'

    const form = root.querySelector('#password-form')
    const input = root.querySelector('#password-input')
    const submit = root.querySelector('#unlock-button')
    const status = root.querySelector('#password-status')
    const error = root.querySelector('#password-error')
    const lockButton = root.querySelector('#lock-page')
    const content = root.querySelector('#private-content')
    const endpoint = '/api/private'

    if (!form || !input || !content) {
      return
    }

    const placeholderMarkup = content.innerHTML

    const renderPlaceholder = () => {
      content.innerHTML = placeholderMarkup
      content.dataset.unlocked = 'false'
    }

    const setState = (state) => {
      root.setAttribute('data-state', state)
      if (state === 'unlocked') {
        form.setAttribute('hidden', 'true')
        lockButton?.removeAttribute('hidden')
        content.dataset.unlocked = 'true'
      } else {
        form.removeAttribute('hidden')
        lockButton?.setAttribute('hidden', 'true')
        if (state === 'locked') {
          error?.setAttribute('hidden', 'true')
          renderPlaceholder()
        }
      }
    }

    const setLoading = (isLoading) => {
      if (isLoading) {
        root.setAttribute('data-loading', 'true')
        submit?.setAttribute('disabled', 'true')
        status?.removeAttribute('hidden')
        if (status) {
          status.textContent = 'æ­£åœ¨éªŒè¯â€¦'
        }
      } else {
        root.removeAttribute('data-loading')
        submit?.removeAttribute('disabled')
        if (status) {
          status.textContent = ''
          status.setAttribute('hidden', 'true')
        }
      }
    }

    const renderPayload = (payload = {}) => {
      content.innerHTML = ''
      content.dataset.unlocked = 'true'

      const heroData = payload.hero ?? {
        emoji: 'ğŸ”',
        kicker: 'Private channel',
        title: fallbackTitle,
        body: 'Authorized content'
      }

      const heroCard = document.createElement('div')
      heroCard.className = 'secret-hero card'
      const kicker = document.createElement('p')
      kicker.className = 'hero-kicker'
      kicker.textContent = `${heroData.emoji} ${heroData.kicker}`
      const title = document.createElement('h2')
      title.textContent = heroData.title
      const body = document.createElement('p')
      body.className = 'hero-body'
      body.textContent = heroData.body
      heroCard.append(kicker, title, body)
      if (heroData.note) {
        const note = document.createElement('p')
        note.className = 'hero-note'
        note.textContent = heroData.note
        heroCard.appendChild(note)
      }
      content.appendChild(heroCard)

      if (Array.isArray(payload.sections)) {
        payload.sections.forEach((section) => {
          if (!section || !Array.isArray(section.entries)) {
            return
          }
          const sectionEl = document.createElement('section')
          sectionEl.className = 'secret-section card'

          const header = document.createElement('div')
          header.className = 'section-head'
          const h3 = document.createElement('h3')
          h3.textContent = section.title
          header.appendChild(h3)
          if (section.description) {
            const desc = document.createElement('p')
            desc.className = 'section-desc'
            desc.textContent = section.description
            header.appendChild(desc)
          }
          sectionEl.appendChild(header)

          const list = document.createElement('div')
          list.className = 'secret-entries'

          section.entries.forEach((entry) => {
            const row = document.createElement('div')
            row.className = 'secret-entry'

            const label = document.createElement('span')
            label.className = 'entry-label'
            label.textContent = entry.label

            const valueWrapper = document.createElement('div')
            valueWrapper.className = 'entry-value-wrapper'

            const value = document.createElement('code')
            value.className = 'entry-value'
            value.textContent = entry.value

            valueWrapper.appendChild(value)

            row.append(label, valueWrapper)

            if (entry.hint) {
              const hint = document.createElement('p')
              hint.className = 'entry-hint'
              hint.textContent = entry.hint
              row.appendChild(hint)
            }

            list.appendChild(row)
          })

          sectionEl.appendChild(list)

          if (section.note) {
            const note = document.createElement('p')
            note.className = 'section-note'
            note.textContent = section.note
            sectionEl.appendChild(note)
          }

          content.appendChild(sectionEl)
        })
      }

      if (payload.meta) {
        const meta = document.createElement('footer')
        meta.className = 'secret-meta'
        const owner = payload.meta.owner ? `Owner Â· ${payload.meta.owner}` : null
        const updated = payload.meta.lastUpdated ? `Last updated Â· ${payload.meta.lastUpdated}` : null
        const sensitivity = payload.meta.sensitivity
          ? `Classification Â· ${payload.meta.sensitivity}`
          : null

        const bits = [owner, updated, sensitivity].filter(Boolean)
        meta.innerHTML = bits.map((bit) => `<span>${bit}</span>`).join('')
        content.appendChild(meta)
      }
    }

    const requestPayload = async (password) => {
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ password })
      })

      const data = await response.json().catch(() => ({}))
      if (!response.ok) {
        throw new Error(data?.error || 'Access denied.')
      }
      return data.payload
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault()
      error?.setAttribute('hidden', 'true')

      const password = input.value.trim()
      if (!password) {
        input.focus()
        return
      }

      setLoading(true)

      try {
        const payload = await requestPayload(password)
        renderPayload(payload)
        setState('unlocked')
        input.value = ''
      } catch (err) {
        setState('locked')
        error?.removeAttribute('hidden')
        if (error && err instanceof Error) {
          error.textContent = err.message
        }
        input.select()
      } finally {
        setLoading(false)
      }
    })

    lockButton?.addEventListener('click', () => {
      input.value = ''
      setState('locked')
      input.focus()
    })

    setState('locked')
  }

  initPrivatePage()
  document.addEventListener('astro:page-load', initPrivatePage)
</script>

<style>
  .private-page {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .private-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    text-align: center;
  }

  .header-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 64px;
    height: 64px;
    border-radius: 1.5rem;
    background: linear-gradient(135deg, rgba(124, 58, 237, 0.15), rgba(14, 165, 233, 0.15));
    border: 1px solid color-mix(in srgb, var(--border) 70%, transparent);
    color: var(--text-primary);
    transition: transform 0.3s ease;
  }

  .header-icon:hover {
    transform: rotate(-5deg) scale(1.05);
  }

  .private-header h1 {
    margin: 0;
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--text-primary), color-mix(in srgb, var(--text-primary) 60%, #7c3aed));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.2em;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin: 0;
  }

  .lede {
    margin: 0;
    color: var(--text-secondary);
    max-width: 52ch;
    line-height: 1.6;
  }

  .card {
    position: relative;
    padding: 1.5rem;
    border-radius: 1.25rem;
    border: 1px solid color-mix(in srgb, var(--border) 70%, transparent);
    background: color-mix(in srgb, var(--bg) 90%, var(--astro-code-background));
    backdrop-filter: blur(12px);
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.12);
  }

  .password-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .password-form label {
    font-weight: var(--font-weight-medium);
  }

  .input-row {
    display: flex;
    gap: 0.75rem;
  }

  .input-row input {
    flex: 1;
    padding: 0.85rem 1rem;
    border-radius: 1rem;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text-primary);
  }

  .input-row button {
    inline-size: min(8rem, 30%);
    border-radius: 1rem;
    border: none;
    background: linear-gradient(120deg, var(--text-primary), color-mix(in srgb, var(--text-primary) 70%, var(--accent, #7c3aed)));
    color: var(--bg);
    font-weight: var(--font-weight-bold);
    cursor: pointer;
    transition: transform 0.15s ease;
  }

  [data-loading='true'] .input-row button {
    pointer-events: none;
    opacity: 0.75;
  }

  .input-row button:hover {
    transform: translateY(-1px);
  }

  .status,
  .error {
    margin: 0;
    font-size: 0.9rem;
  }

  .status {
    color: var(--text-secondary);
  }

  .error {
    color: #d93025;
  }

  .secondary {
    align-self: flex-start;
    padding: 0.65rem 1.25rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-primary);
    cursor: pointer;
    transition: border-color 0.2s ease;
  }

  .secondary:hover {
    border-color: var(--text-primary);
  }

  .private-content {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .lock-placeholder {
    position: relative;
    overflow: hidden;
    border-radius: 1rem;
    padding: 1.25rem;
    background: color-mix(in srgb, var(--astro-code-background) 85%, transparent);
    isolation: isolate;
  }

  .placeholder-kicker {
    margin: 0;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.3em;
    color: var(--text-secondary);
  }

  .lock-placeholder h2 {
    margin: 0.5rem 0 0.25rem;
  }

  .lock-placeholder p {
    margin: 0;
    color: var(--text-secondary);
  }

  .placeholder-glow {
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at top, rgba(124, 58, 237, 0.25), transparent 60%);
    filter: blur(20px);
    z-index: -1;
  }

  .secret-hero {
    background: linear-gradient(135deg, rgba(124, 58, 237, 0.15), rgba(14, 165, 233, 0.15));
  }

  .hero-kicker {
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.25em;
    font-size: 0.75rem;
    color: var(--text-secondary);
  }

  .hero-body,
  .hero-note {
    margin: 0.75rem 0 0;
  }

  .hero-note {
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  .secret-section {
    border: 1px dashed color-mix(in srgb, var(--border) 90%, transparent);
  }

  .section-head h3 {
    margin: 0;
  }

  .section-desc {
    margin: 0.35rem 0 0;
    color: var(--text-secondary);
  }

  .secret-entries {
    margin-top: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .secret-entry {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .entry-label {
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.3em;
    color: var(--text-secondary);
  }

  .entry-value-wrapper {
    background: rgba(255, 255, 255, 0.04);
    border-radius: 0.75rem;
    border: 1px dashed color-mix(in srgb, var(--border) 80%, transparent);
    padding: 0.75rem 1rem;
  }

  .entry-value {
    display: block;
    width: 100%;
    word-break: break-all;
  }

  .entry-hint {
    margin: 0;
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  .section-note {
    margin: 0.75rem 0 0;
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  .secret-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    font-size: 0.8rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-secondary);
  }

  @media (max-width: 768px) {
    .private-header h1 {
      font-size: 2.25rem;
    }

    .header-icon {
      width: 60px;
      height: 60px;
    }

    .card {
      padding: 1.25rem;
    }

    .input-row {
      gap: 0.5rem;
    }

    .input-row input {
      padding: 0.75rem 0.9rem;
      font-size: 0.95rem;
    }

    .input-row button {
      padding: 0.75rem 1.5rem;
      font-size: 0.95rem;
    }
  }

  @media (max-width: 640px) {
    .private-header h1 {
      font-size: 2rem;
    }

    .header-icon {
      width: 56px;
      height: 56px;
    }

    .eyebrow {
      font-size: 0.7rem;
    }

    .lede {
      font-size: 0.95rem;
    }

    .card {
      padding: 1.25rem;
    }

    .password-form {
      gap: 0.85rem;
    }

    .input-row {
      flex-direction: column;
      align-items: stretch;
      gap: 0.75rem;
    }

    .input-row input {
      padding: 0.85rem 1rem;
      font-size: 1rem;
    }

    .input-row button {
      inline-size: 100%;
      padding: 0.9rem 1.5rem;
      font-size: 1rem;
    }
  }

  @media (max-width: 480px) {
    .private-header h1 {
      font-size: 1.75rem;
    }

    .header-icon {
      width: 52px;
      height: 52px;
    }

    .eyebrow {
      font-size: 0.65rem;
      letter-spacing: 0.15em;
    }

    .lede {
      font-size: 0.9rem;
    }

    .card {
      padding: 1rem;
      border-radius: 1rem;
    }

    .password-form {
      gap: 0.75rem;
    }

    .password-form label {
      font-size: 0.9rem;
    }

    .input-row input {
      padding: 0.8rem 0.9rem;
      font-size: 0.95rem;
      border-radius: 0.85rem;
    }

    .input-row button {
      padding: 0.85rem 1.25rem;
      font-size: 0.95rem;
      border-radius: 0.85rem;
    }

    .status,
    .error {
      font-size: 0.85rem;
    }
  }

  @media (max-width: 360px) {
    .private-header h1 {
      font-size: 1.5rem;
    }

    .header-icon {
      width: 48px;
      height: 48px;
    }

    .eyebrow {
      font-size: 0.6rem;
    }

    .lede {
      font-size: 0.85rem;
    }

    .card {
      padding: 0.85rem;
    }

    .input-row input,
    .input-row button {
      font-size: 0.9rem;
    }
  }

  
</style>
