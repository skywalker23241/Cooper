---
import IndexLayout from '@/layouts/IndexLayout.astro'

const pageTitle = 'Private Notes'
const pageDescription = 'Unlock a tucked-away space with a passphrase.'
const pagePassword = import.meta.env.PUBLIC_PRIVATE_PAGE_PASSWORD || 'cooper-secret'
---

<IndexLayout title={pageTitle} description={pageDescription}>
  <section class="private-page" aria-live="polite">
    <header class="private-header">
      <h1>{pageTitle}</h1>
      <p class="lede">
        This page keeps personal snippets and reminders behind a simple passphrase. Enter it below
        to reveal the content.
      </p>
    </header>

    <form
      id="password-form"
      class="password-form card"
      data-password={pagePassword}
      autocomplete="off"
    >
      <label for="password-input">Access passphrase</label>
      <div class="input-row">
        <input
          id="password-input"
          name="password"
          type="password"
          placeholder="Enter the passphrase"
          minlength="4"
          required
        />
        <button type="submit">Unlock</button>
      </div>
      <p id="password-error" class="error" hidden>The passphrase doesn't match. Try again.</p>
    </form>

    <article id="private-content" class="private-content card" hidden>
      <h2>Unlocked space</h2>
      <p>Use this area for private notes, draft thoughts, or collections you only want to see.</p>
      <p>
        The default passphrase is <code>cooper-secret</code>. Override it during deployment with the
        <code>PUBLIC_PRIVATE_PAGE_PASSWORD</code> environment variable.
      </p>
      <button id="lock-page" type="button" class="secondary">Lock this page</button>
      <p class="tip">
        Reminder: even with a passphrase, static-site content can be inspected. Avoid storing
        anything truly sensitive here.
      </p>
    </article>
  </section>
</IndexLayout>

<script type="module">
  const form = document.querySelector('#password-form')
  const input = document.querySelector('#password-input')
  const error = document.querySelector('#password-error')
  const content = document.querySelector('#private-content')
  const lockButton = document.querySelector('#lock-page')
  const storageKey = 'cooper-private-page'

  const storedUnlock = typeof localStorage !== 'undefined' ? localStorage.getItem(storageKey) : null
  const expectedPassword = form?.dataset.password ?? ''

  const unlock = () => {
    form?.setAttribute('hidden', 'true')
    content?.removeAttribute('hidden')
    error?.setAttribute('hidden', 'true')
  }

  const lock = () => {
    form?.removeAttribute('hidden')
    content?.setAttribute('hidden', 'true')
    input?.focus()
    if (typeof localStorage !== 'undefined') {
      localStorage.removeItem(storageKey)
    }
  }

  if (storedUnlock === 'true') {
    unlock()
  }

  form?.addEventListener('submit', (event) => {
    event.preventDefault()
    const value = input?.value ?? ''

    if (value === expectedPassword) {
      if (typeof localStorage !== 'undefined') {
        localStorage.setItem(storageKey, 'true')
      }
      unlock()
    } else {
      error?.removeAttribute('hidden')
      input?.select()
    }
  })

  lockButton?.addEventListener('click', () => {
    lock()
  })
</script>

<style>
  [hidden] {
    display: none !important;
  }

  .private-page {
    display: flex;
    flex-direction: column;
    gap: 1.75rem;
  }

  .private-header {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .private-header h1 {
    margin: 0;
  }

  .lede {
    margin: 0;
    color: var(--text-secondary);
    max-width: 45ch;
  }

  .private-page .card {
    margin: 0;
    background: var(--code-bg);
  }

  .password-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .input-row {
    display: flex;
    gap: 0.75rem;
  }

  .input-row input {
    flex: 1;
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    border: 1px solid var(--border);
    background: var(--bg);
    font-size: 1rem;
    color: var(--text-primary);
  }

  .input-row button {
    padding: 0.75rem 1.5rem;
    border-radius: 0.75rem;
    border: 1px solid transparent;
    background: var(--text-primary);
    color: var(--bg);
    font-weight: var(--font-weight-bold);
    cursor: pointer;
    transition:
      transform 0.15s ease,
      opacity 0.2s ease;
  }

  .input-row button:hover {
    transform: translateY(-1px);
    opacity: 0.85;
  }

  .error {
    margin: 0;
    color: #d93025;
    font-size: 0.9rem;
  }

  .private-content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .private-content code {
    padding: 0.15rem 0.35rem;
    background: var(--code-bg);
    border-radius: 0.35rem;
    font-family: var(--mono);
  }

  .secondary {
    align-self: flex-start;
    padding: 0.5rem 1rem;
    border-radius: 0.75rem;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-secondary);
    cursor: pointer;
    transition:
      background 0.15s ease,
      color 0.15s ease;
  }

  .secondary:hover {
    background: var(--selection);
    color: var(--text-primary);
  }

  .tip {
    margin: 0.5rem 0 0;
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  @media (max-width: 640px) {
    .input-row {
      flex-direction: column;
    }

    .input-row button {
      width: 100%;
    }
  }
</style>
